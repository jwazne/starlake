CREATE VIEW SL_INCOMING as
{% if strategyOn == 'TARGET' %}
    {{ selectStatement }};
{% else %} {# strategyOn == 'SOURCE_AND_TARGET' #}

    SELECT {{ tableColumnsCsv }}
    FROM ({{ selectStatement }}) AS SL_INCOMING
    QUALIFY ROW_NUMBER() OVER (PARTITION BY {{ strategyKeyCsv }} ORDER BY {{ strategyTimestamp }} DESC) = 1;

{% endif %}

CREATE VIEW SL_2 AS
SELECT {{ renderStrategyKeyAsPseudo(strategyKey, 'SL_INCOMING') }}, SL_INCOMING.* FROM SL_INCOMING
UNION ALL
SELECT {{ renderStrategyKeyAsNullPseudo(strategyKey) }}, SL_INCOMING.* FROM SL_INCOMING
INNER JOIN {{ tableFullName }} SL_EXISTING
ON ({{ strategyKeyJoinCondition }} AND SL_EXISTING.{{strategyEndTs}} IS NULL);


MERGE INTO {{ tableFullName }} SL_EXISTING USING SL_2
ON ({{ renderStrategyJoinConditionWithPseudo('SL_2', 'SL_EXISTING', strategyKey) }})
WHEN MATCHED THEN UPDATE SET {{ strategyEndTs }} = CURRENT_TIMESTAMP
WHEN NOT MATCHED THEN
INSERT ({{ renderColumnsWithoutScd2(tableColumnNames, "") }}, {{ quote }}{{ strategyStartTs }}{{ quote }}, {{ quote }}{{ strategyEndTs }}{{ quote }} )
VALUES ({{ renderColumnsWithoutScd2(tableColumnNames, 'SL_2.') }}, CURRENT_TIMESTAMP, NULL);
