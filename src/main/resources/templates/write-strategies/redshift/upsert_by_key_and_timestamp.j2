
{% macro renderStrategyKeyJoinCondition(table1, table2, columnNames) %}
{% for columnName in columnNames %}{{table1}}.{{ columnName }} = {{table2}}.{{ columnName }}{% if not loop.last %} AND {% endif %}{%endfor%}
{% endmacro %}



{% if strategyOn == 'TARGET' %}

CREATE  TEMPORARY TABLE SL_INCOMING AS {{selectStatement }};

MERGE INTO  {{ tableFullName }} USING SL_INCOMING ON ( {{ strategyKeyJoinCondition }})
WHEN MATCHED AND SL_INCOMING.{{ strategyTimestamp }} > {{ tableFullName }}.{{ strategyTimestamp }} THEN  {{ tableUpdate }}
WHEN NOT MATCHED THEN {{ tableInsert }}


{% else %} {# strategyOn == 'SOURCE_AND_TARGET' #}
CREATE  TEMPORARY TABLE SL_INCOMING AS
SELECT  {{ tableColumnsCsv }}
FROM (
    SELECT  {{ tableColumnsCsv }}, ROW_NUMBER() OVER (PARTITION BY {{ strategyKeyCsv }}  ORDER BY {{ strategyTimestamp }} DESC) AS SL_SEQ
    FROM ({{ selectStatement }}) SL_TMP
) SL_TMP
WHERE SL_SEQ = 1;

MERGE INTO  {{ tableFullName }}
USING SL_INCOMING
ON ( {{ strategyKeyJoinCondition }})
WHEN MATCHED AND SL_INCOMING.{{ strategyTimestamp }} > SL_EXISTING.{{ strategyTimestamp }} THEN  {{ tableUpdate }}
WHEN NOT MATCHED THEN {{ tableInsert }}

{%  endif %}
