
{#

{{ sinkConnectionRef }}
{{ sinkClustering }}
{{ sinkDays }}
{{ sinkRequirePartitionFilter }}
{{ sinkMaterializedView }}
{{ sinkEnableRefresh }}
{{ sinkRefreshIntervalMs }}
{{ sinkId }}
{{ sinkFormat }}
{{ sinkExtension }}
{{ sinkPartition }}
{{ sinkCoalesce }}
{{ sinkOptions }}


{{ tableDatabase }}
{{ tableDomain }}
{{ tableName }}
{{ tableColumnNames }}
{{ tableFullName }}
{{ selectStatement }}
{{ tableExists }}
{{ tableTruncate }}
{{ tableParamsForInsertSql }}
{{ tableParamsForUpdateSql }}
{{ tableInsert }}
{{ tableUpdate }}
{{ tableColumnsCsv }}
{{ tableIncomingColumnsCsv }}
{{ materializedView }}

{{ engineQuote }}
{{ engineCanMerge }}
{{ engineViewPrefix }}
{{ enginePreActions }}
{{ engineStrategyBuilder }}

{{ strategyType }}
{{ strategyTypes }}
{{ strategyKey }}
{{ strategyTimestamp }}
{{ strategyQueryFilter }}
{{ strategyOn }}
{{ strategyStartTs }}
{{ strategyEndTs }}
{{ strategyKeyCsv }}
{{ strategyKeyJoinCondition }}

#}

{% macro makeMD5(columnNames) %}
{% for columnName in columnNames %}{{ columnName }}{% if not loop.last %} || '-' {% endif %}{%endfor%}
{% endmacro %}

{% if columnNames|length > 1 %}

DELETE FROM {{ tableFullName }} 
WHERE {{ makeMD5(strategyKey) }} in 
(
    SELECT {{ makeMD5(strategyKey) }} FROM ({{ selectStatement }})
);

{% else %}

DELETE FROM {{ tableFullName }} 
WHERE {{ strategyKeyCsv }} in 
(
    SELECT {{ strategyKeyCsv }} FROM ({{ selectStatement }})
);

{% endif%}
INSERT INTO {{ tableFullName }} ({{ tableColumnsCsv }}) {{ selectStatement }};

