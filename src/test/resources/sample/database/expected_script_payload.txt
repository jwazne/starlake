-- MISE EN FORME POUR L'ECRITURE DANS LE FICHIER
SET FEED OFF
SET ECHO OFF
SET VERIFY OFF
SET HEADING OFF
SET TERMOUT OFF
SET CONCAT "#"
SET MARKUP CSV ON DELIMITER ","
-- ARRET EN ECHEC EN CAS D'ERREUR SQL
WHENEVER SQLERROR exit 1;

-- RECUPERATION DU DOSSIER DE SORTIE
DEFINE OUTPUT_DIR = &1;

-- STOCKAGE DU DATE TIME COURANT EN STRING DANS DATE_TIME_CHAR
DEFINE DATE_TIME_PATTERN = 'yyyymmddhhmiss';
COLUMN DT_VAL NEW_VALUE CURRENT_EXPORT_DATE_CHAR;
SELECT TO_CHAR(SYSDATE, '&DATE_TIME_PATTERN') DT_VAL FROM DUAL;

-- STOCKAGE DE LA DATE DE DERNIER EXPORT DANS LAST_EXPORT_DATE
COLUMN LED NEW_VALUE LAST_EXPORT_DATE;
SELECT
    COALESCE(
        (
            SELECT
                DA_LAST_EXPORT_DATE
            FROM
                L58OT.L58MA_EXPORT_STATUS
            WHERE
                LI_TABLE_NAME = 'TABLE1'
        ),
        TO_DATE('19700101','yyyymmdd') -- SI PAS D'EXPORT DATE EN TABLE, EPOCH
    ) LED
FROM
    DUAL;

-- OUVERTURE DU FICHIER
PROMPT EXPORTING TABLE1 TO &OUTPUT_DIR#/output_file_DELTA_&CURRENT_EXPORT_DATE_CHAR#.csv;
SPOOL &OUTPUT_DIR#/output_file_DELTA_&CURRENT_EXPORT_DATE_CHAR#.csv REPLACE

SELECT
    COL1, COL2
FROM
    L58OB.TABLE1
WHERE
    UPDATECOL >= '&LAST_EXPORT_DATE';
-- FERMETURE DU FICHIER
SPOOL OFF

-- MISE À JOUR DE LA TABLE REPORTING
BEGIN
    UPDATE
        L58OT.L58MA_EXPORT_STATUS
    SET
        LI_SCHEMA_NAME = 'L58OB',
        LI_TABLE_NAME = 'TABLE1',
        DA_LAST_EXPORT_DATE = TO_DATE(&CURRENT_EXPORT_DATE_CHAR, '&DATE_TIME_PATTERN'),
        TYPE_LAST_EXPORT = 'DELTA',
        NB_ROWS_LAST_EXPORT = (
            SELECT
                COUNT(*)
            FROM
                L58OB.TABLE1
            WHERE
                UPDATECOL >= '&LAST_EXPORT_DATE'
        )
    WHERE
        LI_TABLE_NAME = 'TABLE1';
    IF
        SQL%ROWCOUNT = 0
    THEN -- PAS DE LIGNE UPDATEES
        INSERT INTO
            L58OT.L58MA_EXPORT_STATUS (LI_SCHEMA_NAME, LI_TABLE_NAME, DA_LAST_EXPORT_DATE, TYPE_LAST_EXPORT, NB_ROWS_LAST_EXPORT)
        VALUES
            (
                'L58OB',
                'TABLE1',
                TO_DATE(&CURRENT_EXPORT_DATE_CHAR, '&DATE_TIME_PATTERN'),
                'DELTA',
                (
                    SELECT
                        COUNT(*)
                    FROM
                        L58OB.TABLE1
                    WHERE
                        UPDATECOL >= '&LAST_EXPORT_DATE'
                )
            );
    END IF;
END;
/

EXIT SUCCESS